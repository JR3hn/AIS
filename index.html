<!DOCTYPE html>
<html lang="en">

<head>
    <title>Vässarö AIS</title>
    <link rel="icon" type="image/x-icon" href="img/vassaro_kvadrat.jpeg">
    <meta charset="utf-8" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.1/src/leaflet.geometryutil.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
    <!-- <script src="https://kit.fontawesome.com/c7032de331.js" crossorigin="anonymous"></script> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
        integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="src/leaflet.nauticalscale.js"></script>
    <link rel="stylesheet" href="style.css" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>

<body>
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="./">
                <img src="img/vassaro_logga.jpg">&nbsp;Vässarö AIS
                <!-- <i class="fa-solid fa-anchor"></i>&nbsp;Vässarö AIS -->
            </a>

            <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navMenu">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>


        </div>
        <div class="navbar-menu" id="navMenu">
            <!-- <div class="navbar-start"> -->
            <!-- <a class="navbar-item" href="/"><i class="fa-solid fa-info"></i>Info</a> -->
            <!-- <a class="navbar-item" href="/"><i class="fa-solid fa-ship"></i>Ships</a> -->
            <!-- </div> -->
            <div class="navbar-end">
                <div class="navbar-item has-dropdown is-hoverable">
                    <a class="navbar-link hidden-mobile">
                        <i class="fa-solid fa-ship"></i>&nbsp;Fartyg
                    </a>
                    <div class="navbar-dropdown is-right">
                        <div class="navbar-item is-flex is-align-items-center">
                            <label class="custom-switch">
                                <input type="checkbox" id="showAllShipsSwitch">
                                <span class="custom-slider"></span>
                            </label>Visa alla fartyg</span>
                        </div>
                        <div class="navbar-item" style="">
                            <div class="table-container" style="max-height: 500px; overflow: scroll;">
                                <table class="table is-striped is-fullwidth">
                                    <thead>
                                        <tr>
                                            <th>Namn</th>
                                            <th>Fart</th>
                                            <th colspan="2">Kurs</th>
                                        </tr>
                                    </thead>
                                    <tbody id="shipTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                        <hr class="navbar-divider">
                        <div class="navbar-item">
                            <div class="content">
                                <p>
                                    &copy; Vässarö, <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>
                                    contributors.
                                </p>
                                <p class="is-centered">
                                    Den här hemsidan bor på Github:&nbsp;
                                    <a href="https://github.com/JR3hn/AIS">
                                        <i class="fa-brands fa-github"></i>
                                    </a>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div id="map"></div>

</body>

<script>

    // LEAFLET MAP
    const BASEMAPS = {
        OpenStreetMap: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            // attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors.</a>.'
        }),
        Satellit: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '&copy; <a href="https://www.arcgis.com/home/item.html?id=10df2279f9684e4a9f6a7f08febac2a9">Esri, Maxar, Earthstar Geographics, and the GIS User Community</a>.'
        })
    };

    // Kartan börjar centrerad runt Strömsviken - Djuphamn
    var lfmap = L.map('map', {
        center: [60.24521, 18.68388],
        zoom: 13,
        // minZoom: 10,
        zoomControl: false,
        layers: [BASEMAPS.OpenStreetMap],
        attributionControl: false
    });

    const SOUTH_WEST = L.latLng(60.0, 18.0);
    const NORTH_EAST = L.latLng(60.4, 19.0);
    const BOUNDS = L.latLngBounds(SOUTH_WEST, NORTH_EAST);
    lfmap.setMaxBounds(BOUNDS);
    lfmap.on('drag', function () {
        lfmap.panInsideBounds(BOUNDS, { animate: true });
    });

    const SCALE = new L.control.scaleNautical({
        maxWidth: 300,
        nauticalMilesUnit: "sjömil"
    }).addTo(lfmap);


    let showAllShips = false;

    document.getElementById('showAllShipsSwitch').addEventListener('change', function (event) {
        showAllShips = event.target.checked;
        // Ta bort alla nuvarande markörer och vektorer
        Object.values(shipMarkers).forEach(marker => lfmap.removeLayer(marker));
        Object.values(shipVectors).forEach(vector => lfmap.removeLayer(vector));
        shipMarkers = {};
        shipVectors = {};
        // Lägg till markörer igen enligt nya filtret
        Object.values(shipLastUpdate).forEach(message => {
            createMarker(message);
        });
    });

    // WEB SOCKET
    const ws = new WebSocket("wss://jumpgate.vassaro.net/ws/");

    var shipLastUpdate = {};

    ws.onmessage = (event) => {
        if (event.data.startsWith('42["vesselPositions-init"')) {
            const vessels = JSON.parse(event.data.toString().slice(2))[1];
            vessels.forEach(message => {
                const shipName = message.name && message.name.trim();
                if (!shipName) return;
                if (!shipLastUpdate[shipName]) {
                    createMarker(message);
                    shipLastUpdate[shipName] = message;
                }
            });
        } else {
            const message = JSON.parse(event.data.toString().slice(2))[1];
            const shipName = message.name && message.name.trim();
            if (shipName) {
                shipLastUpdate[shipName] = message;
            }
            createMarker(message);
        }
    };

    ws.onclose = (event) => {
        console.log("Connection closed", event.code, event.reason, event.wasClean)
    };

    ws.onerror = () => {
        console.log("Connection closed due to error")
    };

    const arrowIcon = L.icon({
        iconUrl: 'img/Boat marker.svg',
        iconSize: [42, 42],
        iconAnchor: [21, 21], // mitten av ikonen
    });

    const locationIcon = L.divIcon({
        html: '<i style="color: var(--harbor-color)" class="fa-solid fa-location-crosshairs fa-2x"></i>',
        iconSize: [42, 42],
        iconAnchor: [21, 21], // mitten av ikonen
        className: "locationIcon"
    });

    const HARBORS = [
        ["Djuphamn", [60.259901, 18.691059]],
        ["Fladan", [60.261266, 18.698441]],
        ["Strömsviken", [60.216261, 18.725735]],
        ["Öregrund", [60.340856, 18.442161]],
        ["Äspskär", [60.30136, 18.59455]],
        ["Sundsveden", [60.251664, 18.60996]]
    ]

    HARBORS.forEach(harbor => {
        // console.log(harbor)
        const harbourMarker = L.marker(harbor[1], {
            icon: locationIcon,
            title: harbor[0]
        })
            .bindPopup(harbor[0], {
                offset: [0, -10],
                className: "shipPopup",
            })
            .addTo(lfmap);
    });

    // CREATE MARKERS, filtered by this array
    const TRACKED_SHIPS = ["VIGGEN", "MASEN"];

    var shipMarkers = {};

    var shipVectors = {};

    function formatName(name) {
        var splitString = name.toLowerCase().split(" ");
        for (var i = 0; i < splitString.length; i++) {
            splitString[i] = splitString[i].charAt(0).toUpperCase() + splitString[i].substring(1);
        }
        return splitString.join(" ");
    }

    function createMarker(message) {
        if (!message.coordinates || !message.name) return;
        const shipName = message.name.trim();

        const infoHTML = `
            <table>
                <thead>
                    <tr>
                        <td style="font-weight: bold;"><i class="fa-solid fa-ship"></i></td>
                        <td style="font-weight: bold;">${formatName(shipName) || "<i>Inget namn...</i>"}</td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Fart:</td>
                        <td>${message.speed || "0"} knop</td>
                    </tr>
                    <tr>
                        <td>Kurs:</td>
                        <td>${message.course || "-"}&deg;</td>
                    </tr>
                    <tr>
                        <td>Status:</td>
                        <td>${message.navigationalStatus || "-"}</td>
                    </tr>
                    <tr>
                        <td>Legend:</td>
                        <td>${message.legend || "-"}</td>
                    </tr>
                    <tr>
                        <td>Koordinater:</td>
                        <td>N${parseFloat(message.coordinates[0]).toFixed(5)}, E${parseFloat(message.coordinates[1]).toFixed(5)}</td>
                    </tr>
                </tbody>
            </table>
        `;

        if (
            (
                showAllShips ||
                TRACKED_SHIPS.includes(shipName) ||
                shipName.toUpperCase().includes("RESCUE") ||
                (shipName.toUpperCase().includes("VASSARO") && !shipName.toUpperCase().includes("REF POINT"))
            )
            && !shipName.toUpperCase().includes("REF POINT")
        ) {
            // console.log(message)
            if (shipMarkers[shipName]) {
                shipMarkers[shipName]
                    .setLatLng(message.coordinates)
                    .setRotationAngle(message.course || 0)
                    .setPopupContent(infoHTML)
            } else {
                const marker = L.marker(message.coordinates, {
                    rotationAngle: message.course || 0,
                    icon: arrowIcon
                });
                marker.bindPopup(infoHTML, {
                    offset: [0, -10],
                    className: "shipPopup",
                });

                marker.bindTooltip(`${formatName(shipName) || "<i>Inget namn...</i>"}`, {
                    offset: [20, 0],
                    permanent: true
                }).openTooltip();

                marker.addTo(lfmap);
                shipMarkers[shipName] = marker;
            }

            // CREATE PREDICTING VECTOR
            if (shipVectors[shipName]) {
                lfmap.removeLayer(shipVectors[shipName]);
            }
            if (typeof message.course === "number" && typeof message.speed === "number" && message.speed > 0.5) {
                const distance = message.speed * 100;

                // Skapa LatLng-objekt
                const startPoint = L.latLng(message.coordinates[0], message.coordinates[1]);
                const bearing = message.course;

                // Beräkna endpoint (distans i meter)
                const endPoint = L.GeometryUtil.destination(startPoint, bearing, distance);

                const start = [startPoint.lat, startPoint.lng];
                const end = [endPoint.lat, endPoint.lng];

                const vectorGroup = L.layerGroup();

                // Svart outline (bredare)
                const outline = L.polyline([start, end], {
                    color: 'black',
                    weight: 7,
                    opacity: 1
                });
                vectorGroup.addLayer(outline);

                // Röd linje (ovanpå)
                const polyline = L.polyline([start, end], {
                    color: '#D70077',
                    weight: 3,
                    opacity: 1
                });
                vectorGroup.addLayer(polyline);

                const circle = L.circleMarker(end, {
                    radius: 5,
                    color: 'black',
                    weight: 2,
                    fillColor: '#D70077',
                    fillOpacity: 1
                });
                vectorGroup.addLayer(circle);

                vectorGroup.addTo(lfmap);
                shipVectors[shipName] = vectorGroup;
            }
        }
        updateShipTable();
    };

    document.addEventListener('DOMContentLoaded', () => {

        // Get all "navbar-burger" elements
        const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

        // Add a click event on each of them
        $navbarBurgers.forEach(el => {
            el.addEventListener('click', () => {

                // Get the target from the "data-target" attribute
                const target = el.dataset.target;
                const $target = document.getElementById(target);

                // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
                el.classList.toggle('is-active');
                $target.classList.toggle('is-active');

            });
        });
    });

    function updateShipTable() {
        const shipTableBody = document.getElementById("shipTableBody");
        shipTableBody.innerHTML = ""; // clear old rows

        Object.keys(shipMarkers)
            .sort((a, b) => a.localeCompare(b))
            .forEach(shipName => {
                const message = shipLastUpdate[shipName];
                if (!message) return;

                const row = document.createElement("tr");

                row.innerHTML = `
            <td>${formatName(shipName)}</td>
            <td>${renderSpeed(message)} knop</td>
            <td>${renderCourse(message)}</td>
            <td>
                <button class="button is-small" onclick="focusShip('${shipName}')">
                    <i class="fa-solid fa-crosshairs"></i>
                </button>
            </td>
        `;

                shipTableBody.appendChild(row);
            });
    }

    function focusShip(shipName) {
        const marker = shipMarkers[shipName];
        if (marker) {
            lfmap.setView(marker.getLatLng(), 17, { animate: true });
            burger = document.getElementsByClassName("navbar-burger")[0];
            burger.click();
        }
    }

    function renderSpeed(message) {
        if (message.speed) {
            return message.speed.toFixed(1) > 0.2 ? message.speed.toFixed(1) : 0;
        } else {
            return "-";
        }
    }

    function renderCourse(message) {
        if (message.speed) {
            return message.speed.toFixed(1) > 0.2 ? message.course + "&deg;" : "-";
        } else {
            return "-";
        }
    }

</script>

</html>